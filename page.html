<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Maze3D</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
  </style>
</head>
<body>

  <canvas id="Maze3D" style="margin:8px;border:1px solid black" ></canvas>
  <div id="level" style="min-width: 100px"></div><button onclick="makemaze()">map生成</button>
  <!-- <button onclick="onclick3dm()">3dmode</button>
  <button onclick="onclick2dm()">2dmode</button> -->
  <script>

    let [width,height,level] = [8,6,1]  //マスのサイズ
    const mSize = { x: width*2+1 , y: height*2+1 }; //壁も含めたサイズ
    let mode3D = true;
    const start = { 
      x: 0,
      y: 0
    };
    const goal ={ 
      x: width,
      y: height
    };
    const dirs =[[0,-1],[1,0],[0,1],[-1,0]];//

    const levelbox = document.getElementById("level");
    const canvas = document.getElementById("Maze3D");
    const TileSize = 40;
    [canvas.width,canvas.height] = [width*TileSize,height*TileSize]
    const ctx = canvas.getContext("2d");
    
    let maze = Array.from({ length: mSize.y }, () => Array(mSize.x).fill(1));
    const getRandomInt = (max) => Math.floor(Math.random() * max);

    const mazeInit = () => {
      mSize.x = 2*width+1;
      mSize.y = 2*height+1;
      maze = Array.from({ length: mSize.y }, () => Array(mSize.x).fill(1));
      [start.x,start.y] = [getRandomInt(width),getRandomInt(height)];
      do{
        [goal.x,goal.y] = [getRandomInt(width),getRandomInt(height)];
      }while(goal.x == start.x && goal.y == start.y);      
    }
    function shuffle(array){
      for (let i = 0; i < array.length; i++) {
        const r = getRandomInt(i+1);
        [array[i], array[r]] = [array[r], array[i]];
      }
      return array;
    }
    function makemaze(){
      levelbox.innerText = "LeveL:"+level+"("+width+","+height+")"
      mazeGenerator();
      onclick3dm();
    }
    function mazeGenerator(){
      mazeInit();
      dig(2*start.x+1,2*start.y+1);
      randWallBraek();
      setplayer();
      window.addEventListener("load", main(), false);
    }
    function dig(x,y){
      maze[y][x] = 0;

      const dir = shuffle([...dirs]);
      for (const [dx, dy] of dir) {
        const nx = x + dx * 2;
        const mx = x + dx;
        const ny = y + dy * 2;
        const my = y + dy;

        if (0 < nx && nx < mSize.x - 1 && 0 < ny && ny < mSize.y - 1 && maze[ny][nx] === 1) {
          maze[my][mx] = 0;
          dig(nx, ny);
        }
      }
    }
    function randWallBraek(){
      const breakNum = Math.floor(width*height/5);
      const wallList = [];
      for (let y = 1; y < mSize.y - 1; y++) {
        for (let x = 1; x < mSize.x - 1; x++) {
          if (maze[y][x] === 1) {
            if (x % 2 === 1 || y % 2 === 1) {
              wallList.push({ x, y });
            }
          }
        }
      }
      shuffle(wallList);
      for (let i = 0; i < breakNum && i < wallList.length; i++) {
        const { x, y } = wallList[i];
        maze[y][x] = 0;
      }
    }
    function onclick2dm(){
      mode3D = false;
      canvas.width = width * TileSize;
      canvas.height = height * TileSize;
      draw2dm();
      setPlayerImg();
      player.img.onload = () => {
        ctx.drawImage(player.img, (player.x)*TileSize +4, (player.y)*TileSize +4);
      }
    }
    function draw2dm(){
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      const wallWidth = {
        x: 4,
        y: 4
      }
      ctx.fillStyle = "black";
      for(let y = 0; y <= height; y++){
        for(let x = 0; x <= width; x++){
          let cx = x*2+1;
          let cy = y*2+1;
          if(cx < 2*width*1 && maze[cy-1][cx]==1){
            ctx.fillRect((x*10-1)*wallWidth.x, (y*10-1)*wallWidth.y, 12*wallWidth.x, 2*wallWidth.y);
          }
          if(cy < 2*height+1 && maze[cy][cx-1]==1){
            ctx.fillRect((x*10-1)*wallWidth.x, (y*10-1)*wallWidth.y, 2*wallWidth.x, 12*wallWidth.y);
          }
        }
      }
      ctx.fillStyle="#82d563";
      ctx.fillRect((start.x*10+2)*wallWidth.x, (start.y*10+2)*wallWidth.y , 6*wallWidth.x, 6*wallWidth.y);
      ctx.fillStyle="red";
      ctx.fillRect((goal.x*10+2)*wallWidth.x, (goal.y*10+2)*wallWidth.y , 6*wallWidth.x, 6*wallWidth.y);
    }

    function onclick3dm(){
      mode3D = true;
      canvas.width = 720;
      canvas.height= canvas.width*3/4;
      draw3dm();
    }
    
    function isWall(x,y){
      return (x >= 0 && x < mSize.x && y >= 0 && y < mSize.y && maze[y][x]===1)
    }

    function playerView(){
      const {dir} = player;
      const [x, y] = [2*player.x+ 1, 2*player.y+1];
      const [dirx,diry] = dirs[dir];
      const [dirvx,dirvy] = dirs[(dir+1)%4];
      
      const vw = [
        [
          isWall(x + dirx - 2*dirvx, y + diry - 2*dirvy),
          isWall(x + dirx          , y + diry          ),
          isWall(x + dirx + 2*dirvx, y + diry + 2*dirvy),
        ],
        [
          isWall(x + 3*dirx - 2*dirvx, y + 3*diry - 2*dirvy),
          isWall(x + 3*dirx          , y + 3*diry          ),
          isWall(x + 3*dirx + 2*dirvx, y + 3*diry + 2*dirvy),
        ],
        [
          isWall(x + 5*dirx - 2*dirvx, y + 5*diry - 2*dirvy),
          isWall(x + 5*dirx          , y + 5*diry          ),
          isWall(x + 5*dirx + 2*dirvx, y + 5*diry + 2*dirvy),
        ],
      ];
      const hw =[
        [
          isWall(x - dirvx, y - dirvy),
          isWall(x + dirvx, y + dirvy),
        ],
        [
          isWall(x + 2*dirx - dirvx, y + 2*diry - dirvy),
          isWall(x + 2*dirx + dirvx, y + 2*diry + dirvy),
        ],
        [
          isWall(x + 4*dirx - dirvx, y + 4*diry - dirvy),
          isWall(x + 4*dirx + dirvx, y + 4*diry + dirvy),
        ],
        [
          isWall(x + 6*dirx - dirvx, y + 6*diry - dirvy),
          isWall(x + 6*dirx + dirvx, y + 6*diry + dirvy),
        ],
      ]
      const ff = [
        player.x +   dirx == goal.x && player.y +   diry == goal.y,
        player.x + 2*dirx == goal.x && player.y + 2*diry == goal.y
      ]

      const view ={
        vw: vw,
        hw: hw,
        ff: ff
      }
      return view;
    }
    function draw3dm(){
      const cell = canvas.width/80;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      player.view = playerView();
      const { hw, vw, ff } = player.view;

      ctx.fillStyle = "#555";
      ctx.fillRect(0, 0, canvas.width, 60*cell);
      ctx.fillStyle = "#777"
      ctx.fillRect(0, 0, canvas.width, 19*cell);
      ctx.fillRect(0, 41*cell, canvas.width, 19*cell);
      ctx.lineWidth = 1;

      ctx.fillStyle = "#aaa"
      if(hw[3][0] && vw[2][0] === 0 && vw[2][1] === 0){
        ctx.beginPath();
        ctx.moveTo(22*cell,18*cell);  ctx.lineTo(28*cell,18*cell);
        ctx.lineTo(29*cell,19*cell); ctx.lineTo(29*cell,41*cell);
        ctx.lineTo(28*cell,42*cell); ctx.lineTo(22*cell,42*cell);                  
        ctx.closePath();
        ctx.fill();
      }
      if(hw[3][1] && vw[2][2] === 0 && vw[2][1] === 0){
        ctx.beginPath();
        ctx.moveTo(58*cell,18*cell);  ctx.lineTo(52*cell,18*cell);
        ctx.lineTo(51*cell,19*cell); ctx.lineTo(51*cell,41*cell);
        ctx.lineTo(52*cell,42*cell); ctx.lineTo(58*cell,42*cell);                     
        ctx.closePath();
        ctx.fill();
      }
      if(vw[2][0]){
        ctx.beginPath();
        ctx.moveTo(0*cell,18*cell);  ctx.lineTo(28*cell,18*cell);
        ctx.lineTo(29*cell,19*cell); ctx.lineTo(29*cell,41*cell);
        ctx.lineTo(28*cell,42*cell); ctx.lineTo(0*cell,42*cell);                        
        ctx.closePath();
        ctx.fill();
      }
      if(vw[2][2]){
        ctx.beginPath();
        ctx.moveTo(80*cell,18*cell);  ctx.lineTo(52*cell,18*cell);
        ctx.lineTo(51*cell,19*cell); ctx.lineTo(51*cell,41*cell);
        ctx.lineTo(52*cell,42*cell); ctx.lineTo(80*cell,42*cell);                        
        ctx.closePath();
        ctx.fill();
      }
      if(vw[2][1]){
        ctx.beginPath();
        ctx.moveTo(22*cell,18*cell);  ctx.lineTo(58*cell,18*cell);
        ctx.lineTo(58*cell,42*cell); ctx.lineTo(22*cell,42*cell);                        
        ctx.closePath();
        ctx.fill();
      }
      if(ff[1]){
        ctx.fillStyle = "#000"
        ctx.beginPath();
        ctx.moveTo(30*cell,42.5*cell);  ctx.lineTo(50*cell,42.5*cell);
        ctx.lineTo(52*cell,44.5*cell); ctx.lineTo(28*cell,44.5*cell);                        
        ctx.closePath();
        ctx.fill();
      }

      ctx.fillStyle = "#bbb"
      if(hw[2][0]){
        ctx.beginPath();
        ctx.moveTo(15*cell,13*cell);  ctx.lineTo(23*cell,13*cell);
        if(vw[2][1]){
          ctx.lineTo(28*cell,18*cell); ctx.lineTo(28*cell,42*cell);
        }else{
          ctx.lineTo(29*cell,19*cell); ctx.lineTo(29*cell,41*cell);
        }
        ctx.lineTo(23*cell,47*cell); ctx.lineTo(15*cell,47*cell);                           
        ctx.closePath();
        ctx.fill();
      }
      if(hw[2][1]){
        ctx.beginPath();
        ctx.moveTo(65*cell,13*cell);  ctx.lineTo(57*cell,13*cell);
        if(vw[2][1]){
          ctx.lineTo(52*cell,18*cell); ctx.lineTo(52*cell,42*cell);
        }else{
          ctx.lineTo(51*cell,19*cell); ctx.lineTo(51*cell,41*cell);
        }
        ctx.lineTo(57*cell,47*cell); ctx.lineTo(65*cell,47*cell);                        
        ctx.closePath();
        ctx.fill();
      }
      if(vw[1][0]){
        ctx.beginPath();
        ctx.moveTo(0*cell,13*cell);  ctx.lineTo(23*cell,13*cell);
        ctx.lineTo(25*cell,15*cell); ctx.lineTo(25*cell,45*cell);
        ctx.lineTo(23*cell,47*cell); ctx.lineTo(0*cell,47*cell);                           
        ctx.closePath();
        ctx.fill();
      }
      if(vw[1][2]){
        ctx.beginPath();
        ctx.moveTo(80*cell,13*cell);  ctx.lineTo(57*cell,13*cell);

        ctx.lineTo(55*cell,15*cell); ctx.lineTo(55*cell,45*cell);
        ctx.lineTo(57*cell,47*cell); ctx.lineTo(80*cell,47*cell);                        
        ctx.closePath();
        ctx.fill();
      }
      if(vw[1][1]) ctx.fillRect(15*cell, 13*cell, 50*cell, 34*cell);
      if(ff[0]){
        ctx.fillStyle = "#000"
        ctx.beginPath();
        ctx.moveTo(27*cell,48*cell);  ctx.lineTo(53*cell,48*cell);
        ctx.lineTo(57*cell,53*cell); ctx.lineTo(23*cell,53*cell);                        
        ctx.closePath();
        ctx.fill();
      }

      ctx.fillStyle = "#ccc";
      if(hw[1][0]){
        ctx.beginPath();
        ctx.moveTo(2*cell,4*cell);  ctx.lineTo(14*cell,4*cell);
        if(vw[1][1]){
          ctx.lineTo(23*cell,13*cell); ctx.lineTo(23*cell,47*cell);
        }else{
          ctx.lineTo(25*cell,15*cell); ctx.lineTo(25*cell,45*cell);
        }
        ctx.lineTo(14*cell,56*cell); ctx.lineTo(2*cell,56*cell);                     
        ctx.closePath();
        ctx.fill();
      }
      if(hw[1][1]){
        ctx.beginPath();
        ctx.moveTo(78*cell,4*cell);  ctx.lineTo(66*cell,4*cell);
        if(vw[1][1]){
          ctx.lineTo(57*cell,13*cell); ctx.lineTo(57*cell,47*cell);
        }else{
          ctx.lineTo(55*cell,15*cell); ctx.lineTo(55*cell,45*cell);
        }

        ctx.lineTo(66*cell,56*cell); ctx.lineTo(78*cell,56*cell);                      
        ctx.closePath();
        ctx.fill();
      }
      if(vw[0][0]){
        ctx.beginPath();
        ctx.moveTo(0*cell,4*cell);  ctx.lineTo(14*cell,4*cell);
        ctx.lineTo(18*cell,8*cell); ctx.lineTo(18*cell,52*cell);
        ctx.lineTo(14*cell,56*cell); ctx.lineTo(0*cell,56*cell);                     
        ctx.closePath();
        ctx.fill();
      }
      if(vw[0][2]){
        ctx.beginPath();
        ctx.moveTo(80*cell,4*cell);  ctx.lineTo(66*cell,4*cell);
        ctx.lineTo(62*cell,8*cell); ctx.lineTo(62*cell,52*cell);
        ctx.lineTo(66*cell,56*cell); ctx.lineTo(80*cell,56*cell);                      
        ctx.closePath();
        ctx.fill();
      }
      if(vw[0][1]) ctx.fillRect(2*cell, 4*cell, 76*cell, 52*cell);

      ctx.fillStyle = "#ddd";
      if(hw[0][0]){
        ctx.beginPath();
        ctx.moveTo(0*cell,0*cell);  ctx.lineTo(10*cell,0*cell);
        if(vw[0][1]){
          ctx.lineTo(14*cell,4*cell); ctx.lineTo(14*cell,56*cell);
        }else{
          ctx.lineTo(18*cell,8*cell); ctx.lineTo(18*cell,52*cell);
        }
        ctx.lineTo(10*cell,60*cell); ctx.lineTo(0*cell,60*cell);                     
        ctx.closePath();
        ctx.fill();
      }
      if(hw[0][1]){
        ctx.beginPath();
        ctx.moveTo(80*cell,0*cell);  ctx.lineTo(70*cell,0*cell);
        if(vw[0][1]){
          ctx.lineTo(66*cell,4*cell); ctx.lineTo(66*cell,56*cell);
        }else{
          ctx.lineTo(62*cell,8*cell); ctx.lineTo(62*cell,52*cell);
        }
        ctx.lineTo(70*cell,60*cell); ctx.lineTo(80*cell,60*cell);                      
        ctx.closePath();
        ctx.fill();

        ctx.fillStyle="#000";
        
      }
    }

  //player関連
    const player = new Object();
    function setplayer(){
      player.img = new Image();
      player.x = start.x
      player.y = start.y;
      player.dir = 2; //n:0 e:1 s:2 w:3
      setPlayerImg()
    }
    function setPlayerImg(){
      switch (player.dir){
        case 0: player.img.src = "img/dot_up.png";    break;
        case 1: player.img.src = "img/dot_right.png"; break;
        case 2: player.img.src = "img/dot_down.png";  break;
        case 3: player.img.src = "img/dot_left.png";  break;
      }
    }
    function isGoal(){
      if(player.x == goal.x && player.y == goal.y){
        alert("goal, but next Level is has begun");
        level++;
        width += getRandomInt(2);
        height += getRandomInt(2);
        makemaze();
      }
    };
    
  //key関連
    function keyEvent( event ) { 
      if (event.repeat) return;
      const key_code = event.keyCode;
      if( key_code === 37 ) player.dir = (player.dir+3) % 4;
      if( key_code === 38 ) {
        if(maze[2*player.y+1+dirs[player.dir][1]][2*player.x+1+dirs[player.dir][0]]==0){
          player.x += dirs[player.dir][0];
          player.y += dirs[player.dir][1];
        }
      }
      if( key_code === 39 ) player.dir = (player.dir+1) % 4;
      if( key_code === 40 ) player.dir = (player.dir+2) % 4;
      if(mode3D){
        draw3dm();
      }else{
        draw2dm();
        setPlayerImg();
      }
      event.preventDefault();
      isGoal();
    }
    function main(){
      addEventListener("keydown", keyEvent, false);
    }

  </script>
</body>
</html>